'use strict';

var cov_10uegtnwpw = (function() {
  var path = '/Users/guy/Work/Leo/leo/BotFramework-WebChat/packages/core/src/sagas/incomingActivitySaga.js';
  var hash = '33bb0864b9a2338cdedbc510633f2f02cb9caf0f';
  var global = new Function('return this')();
  var gcv = '__coverage__';
  var coverageData = {
    path: '/Users/guy/Work/Leo/leo/BotFramework-WebChat/packages/core/src/sagas/incomingActivitySaga.js',
    statementMap: {
      '0': {
        start: {
          line: 17,
          column: 2
        },
        end: {
          line: 27,
          column: 3
        }
      },
      '1': {
        start: {
          line: 18,
          column: 4
        },
        end: {
          line: 18,
          column: 69
        }
      },
      '2': {
        start: {
          line: 18,
          column: 58
        },
        end: {
          line: 18,
          column: 67
        }
      },
      '3': {
        start: {
          line: 19,
          column: 9
        },
        end: {
          line: 27,
          column: 3
        }
      },
      '4': {
        start: {
          line: 20,
          column: 4
        },
        end: {
          line: 26,
          column: 5
        }
      },
      '5': {
        start: {
          line: 21,
          column: 6
        },
        end: {
          line: 21,
          column: 68
        }
      },
      '6': {
        start: {
          line: 21,
          column: 60
        },
        end: {
          line: 21,
          column: 66
        }
      },
      '7': {
        start: {
          line: 22,
          column: 11
        },
        end: {
          line: 26,
          column: 5
        }
      },
      '8': {
        start: {
          line: 23,
          column: 6
        },
        end: {
          line: 23,
          column: 67
        }
      },
      '9': {
        start: {
          line: 23,
          column: 60
        },
        end: {
          line: 23,
          column: 65
        }
      },
      '10': {
        start: {
          line: 25,
          column: 6
        },
        end: {
          line: 25,
          column: 71
        }
      },
      '11': {
        start: {
          line: 25,
          column: 60
        },
        end: {
          line: 25,
          column: 69
        }
      },
      '12': {
        start: {
          line: 29,
          column: 2
        },
        end: {
          line: 29,
          column: 18
        }
      },
      '13': {
        start: {
          line: 33,
          column: 2
        },
        end: {
          line: 50,
          column: 5
        }
      },
      '14': {
        start: {
          line: 34,
          column: 4
        },
        end: {
          line: 34,
          column: 59
        }
      },
      '15': {
        start: {
          line: 36,
          column: 4
        },
        end: {
          line: 36,
          column: 42
        }
      },
      '16': {
        start: {
          line: 40,
          column: 30
        },
        end: {
          line: 40,
          column: 71
        }
      },
      '17': {
        start: {
          line: 41,
          column: 32
        },
        end: {
          line: 41,
          column: 79
        }
      },
      '18': {
        start: {
          line: 43,
          column: 4
        },
        end: {
          line: 49,
          column: 5
        }
      },
      '19': {
        start: {
          line: 44,
          column: 57
        },
        end: {
          line: 44,
          column: 76
        }
      },
      '20': {
        start: {
          line: 48,
          column: 6
        },
        end: {
          line: 48,
          column: 95
        }
      },
      '21': {
        start: {
          line: 54,
          column: 2
        },
        end: {
          line: 54,
          column: 40
        }
      }
    },
    fnMap: {
      '0': {
        name: 'patchActivityWithFromRole',
        decl: {
          start: {
            line: 11,
            column: 9
          },
          end: {
            line: 11,
            column: 34
          }
        },
        loc: {
          start: {
            line: 11,
            column: 53
          },
          end: {
            line: 30,
            column: 1
          }
        },
        line: 11
      },
      '1': {
        name: '(anonymous_1)',
        decl: {
          start: {
            line: 18,
            column: 52
          },
          end: {
            line: 18,
            column: 53
          }
        },
        loc: {
          start: {
            line: 18,
            column: 58
          },
          end: {
            line: 18,
            column: 67
          }
        },
        line: 18
      },
      '2': {
        name: '(anonymous_2)',
        decl: {
          start: {
            line: 21,
            column: 54
          },
          end: {
            line: 21,
            column: 55
          }
        },
        loc: {
          start: {
            line: 21,
            column: 60
          },
          end: {
            line: 21,
            column: 66
          }
        },
        line: 21
      },
      '3': {
        name: '(anonymous_3)',
        decl: {
          start: {
            line: 23,
            column: 54
          },
          end: {
            line: 23,
            column: 55
          }
        },
        loc: {
          start: {
            line: 23,
            column: 60
          },
          end: {
            line: 23,
            column: 65
          }
        },
        line: 23
      },
      '4': {
        name: '(anonymous_4)',
        decl: {
          start: {
            line: 25,
            column: 54
          },
          end: {
            line: 25,
            column: 55
          }
        },
        loc: {
          start: {
            line: 25,
            column: 60
          },
          end: {
            line: 25,
            column: 69
          }
        },
        line: 25
      },
      '5': {
        name: 'observeActivity',
        decl: {
          start: {
            line: 32,
            column: 10
          },
          end: {
            line: 32,
            column: 25
          }
        },
        loc: {
          start: {
            line: 32,
            column: 50
          },
          end: {
            line: 51,
            column: 1
          }
        },
        line: 32
      },
      '6': {
        name: 'observeActivity',
        decl: {
          start: {
            line: 33,
            column: 52
          },
          end: {
            line: 33,
            column: 67
          }
        },
        loc: {
          start: {
            line: 33,
            column: 78
          },
          end: {
            line: 50,
            column: 3
          }
        },
        line: 33
      },
      '7': {
        name: 'incomingActivitySaga',
        decl: {
          start: {
            line: 53,
            column: 25
          },
          end: {
            line: 53,
            column: 45
          }
        },
        loc: {
          start: {
            line: 53,
            column: 48
          },
          end: {
            line: 55,
            column: 1
          }
        },
        line: 53
      }
    },
    branchMap: {
      '0': {
        loc: {
          start: {
            line: 17,
            column: 2
          },
          end: {
            line: 27,
            column: 3
          }
        },
        type: 'if',
        locations: [
          {
            start: {
              line: 17,
              column: 2
            },
            end: {
              line: 27,
              column: 3
            }
          },
          {
            start: {
              line: 17,
              column: 2
            },
            end: {
              line: 27,
              column: 3
            }
          }
        ],
        line: 17
      },
      '1': {
        loc: {
          start: {
            line: 19,
            column: 9
          },
          end: {
            line: 27,
            column: 3
          }
        },
        type: 'if',
        locations: [
          {
            start: {
              line: 19,
              column: 9
            },
            end: {
              line: 27,
              column: 3
            }
          },
          {
            start: {
              line: 19,
              column: 9
            },
            end: {
              line: 27,
              column: 3
            }
          }
        ],
        line: 19
      },
      '2': {
        loc: {
          start: {
            line: 20,
            column: 4
          },
          end: {
            line: 26,
            column: 5
          }
        },
        type: 'if',
        locations: [
          {
            start: {
              line: 20,
              column: 4
            },
            end: {
              line: 26,
              column: 5
            }
          },
          {
            start: {
              line: 20,
              column: 4
            },
            end: {
              line: 26,
              column: 5
            }
          }
        ],
        line: 20
      },
      '3': {
        loc: {
          start: {
            line: 22,
            column: 11
          },
          end: {
            line: 26,
            column: 5
          }
        },
        type: 'if',
        locations: [
          {
            start: {
              line: 22,
              column: 11
            },
            end: {
              line: 26,
              column: 5
            }
          },
          {
            start: {
              line: 22,
              column: 11
            },
            end: {
              line: 26,
              column: 5
            }
          }
        ],
        line: 22
      },
      '4': {
        loc: {
          start: {
            line: 43,
            column: 4
          },
          end: {
            line: 49,
            column: 5
          }
        },
        type: 'if',
        locations: [
          {
            start: {
              line: 43,
              column: 4
            },
            end: {
              line: 49,
              column: 5
            }
          },
          {
            start: {
              line: 43,
              column: 4
            },
            end: {
              line: 49,
              column: 5
            }
          }
        ],
        line: 43
      },
      '5': {
        loc: {
          start: {
            line: 44,
            column: 32
          },
          end: {
            line: 44,
            column: 52
          }
        },
        type: 'default-arg',
        locations: [
          {
            start: {
              line: 44,
              column: 50
            },
            end: {
              line: 44,
              column: 52
            }
          }
        ],
        line: 44
      },
      '6': {
        loc: {
          start: {
            line: 48,
            column: 36
          },
          end: {
            line: 48,
            column: 92
          }
        },
        type: 'cond-expr',
        locations: [
          {
            start: {
              line: 48,
              column: 78
            },
            end: {
              line: 48,
              column: 82
            }
          },
          {
            start: {
              line: 48,
              column: 85
            },
            end: {
              line: 48,
              column: 92
            }
          }
        ],
        line: 48
      },
      '7': {
        loc: {
          start: {
            line: 48,
            column: 36
          },
          end: {
            line: 48,
            column: 75
          }
        },
        type: 'binary-expr',
        locations: [
          {
            start: {
              line: 48,
              column: 36
            },
            end: {
              line: 48,
              column: 38
            }
          },
          {
            start: {
              line: 48,
              column: 42
            },
            end: {
              line: 48,
              column: 51
            }
          },
          {
            start: {
              line: 48,
              column: 55
            },
            end: {
              line: 48,
              column: 75
            }
          }
        ],
        line: 48
      }
    },
    s: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0,
      '8': 0,
      '9': 0,
      '10': 0,
      '11': 0,
      '12': 0,
      '13': 0,
      '14': 0,
      '15': 0,
      '16': 0,
      '17': 0,
      '18': 0,
      '19': 0,
      '20': 0,
      '21': 0
    },
    f: {
      '0': 0,
      '1': 0,
      '2': 0,
      '3': 0,
      '4': 0,
      '5': 0,
      '6': 0,
      '7': 0
    },
    b: {
      '0': [0, 0],
      '1': [0, 0],
      '2': [0, 0],
      '3': [0, 0],
      '4': [0, 0],
      '5': [0],
      '6': [0, 0],
      '7': [0, 0, 0]
    },
    _coverageSchema: '43e27e138ebf9cfc5966b082cf9a028302ed4184',
    hash: '33bb0864b9a2338cdedbc510633f2f02cb9caf0f'
  };
  var coverage = global[gcv] || (global[gcv] = {});

  if (coverage[path] && coverage[path].hash === hash) {
    return coverage[path];
  }

  return (coverage[path] = coverageData);
})();

var _interopRequireDefault = require('@babel/runtime/helpers/interopRequireDefault');

Object.defineProperty(exports, '__esModule', {
  value: true
});
exports['default'] = incomingActivitySaga;

var _regenerator = _interopRequireDefault(require('@babel/runtime/regenerator'));

var _effects = require('redux-saga/effects');

var _simpleUpdateIn = _interopRequireDefault(require('simple-update-in'));

var _activities = require('../selectors/activities');

var _activityFromBot = _interopRequireDefault(require('../definitions/activityFromBot'));

var _incomingActivity = _interopRequireDefault(require('../actions/incomingActivity'));

var _observeEach = _interopRequireDefault(require('./effects/observeEach'));

var _setSuggestedActions = _interopRequireDefault(require('../actions/setSuggestedActions'));

var _whileConnected = _interopRequireDefault(require('./effects/whileConnected'));

var _marked =
    /*#__PURE__*/
    _regenerator['default'].mark(observeActivity),
  _marked2 =
    /*#__PURE__*/
    _regenerator['default'].mark(incomingActivitySaga);

function patchActivityWithFromRole(activity, userID) {
  cov_10uegtnwpw.f[0]++;
  cov_10uegtnwpw.s[0]++;

  // Some activities, such as "ConversationUpdate", does not have "from" defined.
  // And although "role" is defined in Direct Line spec, it was not sent over the wire.
  // We normalize the activity here to simplify null-check and logic later.
  // Patch activity.from.role to make sure its either "bot", "user", or "channel"
  if (!activity.from) {
    cov_10uegtnwpw.b[0][0]++;
    cov_10uegtnwpw.s[1]++;
    activity = (0, _simpleUpdateIn['default'])(activity, ['from', 'role'], function() {
      cov_10uegtnwpw.f[1]++;
      cov_10uegtnwpw.s[2]++;
      return 'channel';
    });
  } else {
    cov_10uegtnwpw.b[0][1]++;
    cov_10uegtnwpw.s[3]++;

    if (!activity.from.role) {
      cov_10uegtnwpw.b[1][0]++;
      cov_10uegtnwpw.s[4]++;

      if (activity.from.id === userID) {
        cov_10uegtnwpw.b[2][0]++;
        cov_10uegtnwpw.s[5]++;
        activity = (0, _simpleUpdateIn['default'])(activity, ['from', 'role'], function() {
          cov_10uegtnwpw.f[2]++;
          cov_10uegtnwpw.s[6]++;
          return 'user';
        });
      } else {
        cov_10uegtnwpw.b[2][1]++;
        cov_10uegtnwpw.s[7]++;

        if (activity.from.id) {
          cov_10uegtnwpw.b[3][0]++;
          cov_10uegtnwpw.s[8]++;
          activity = (0, _simpleUpdateIn['default'])(activity, ['from', 'role'], function() {
            cov_10uegtnwpw.f[3]++;
            cov_10uegtnwpw.s[9]++;
            return 'bot';
          });
        } else {
          cov_10uegtnwpw.b[3][1]++;
          cov_10uegtnwpw.s[10]++;
          activity = (0, _simpleUpdateIn['default'])(activity, ['from', 'role'], function() {
            cov_10uegtnwpw.f[4]++;
            cov_10uegtnwpw.s[11]++;
            return 'channel';
          });
        }
      }
    } else {
      cov_10uegtnwpw.b[1][1]++;
    }
  }

  cov_10uegtnwpw.s[12]++;
  return activity;
}

function observeActivity(_ref) {
  var directLine, userID;
  return _regenerator['default'].wrap(function observeActivity$(_context2) {
    while (1) {
      switch ((_context2.prev = _context2.next)) {
        case 0:
          (directLine = _ref.directLine), (userID = _ref.userID);
          cov_10uegtnwpw.f[5]++;
          cov_10uegtnwpw.s[13]++;
          _context2.next = 5;
          return (0, _observeEach['default'])(
            directLine.activity$,
            /*#__PURE__*/
            _regenerator['default'].mark(function observeActivity(activity) {
              var messageActivities, lastMessageActivity, _ref2, _ref2$suggestedAction, actions, to;

              return _regenerator['default'].wrap(function observeActivity$(_context) {
                while (1) {
                  switch ((_context.prev = _context.next)) {
                    case 0:
                      cov_10uegtnwpw.f[6]++;
                      cov_10uegtnwpw.s[14]++;
                      activity = patchActivityWithFromRole(activity, userID);
                      cov_10uegtnwpw.s[15]++;
                      _context.next = 6;
                      return (0, _effects.put)((0, _incomingActivity['default'])(activity));

                    case 6:
                      cov_10uegtnwpw.s[16]++;
                      _context.next = 9;
                      return (0, _effects.select)((0, _activities.ofType)('message'));

                    case 9:
                      messageActivities = _context.sent;
                      lastMessageActivity = (cov_10uegtnwpw.s[17]++, messageActivities[messageActivities.length - 1]);
                      cov_10uegtnwpw.s[18]++;

                      if (!(0, _activityFromBot['default'])(lastMessageActivity)) {
                        _context.next = 22;
                        break;
                      }

                      cov_10uegtnwpw.b[4][0]++;
                      (_ref2 = (cov_10uegtnwpw.s[19]++, lastMessageActivity)),
                        (_ref2$suggestedAction = _ref2.suggestedActions);
                      _ref2$suggestedAction =
                        _ref2$suggestedAction === void 0 ? (cov_10uegtnwpw.b[5][0]++, {}) : _ref2$suggestedAction;
                      (actions = _ref2$suggestedAction.actions), (to = _ref2$suggestedAction.to); // If suggested actions is not destined to anyone, or is destined to the user, show it.
                      // In other words, if suggested actions is destined to someone else, don't show it.

                      cov_10uegtnwpw.s[20]++;
                      _context.next = 20;
                      return (0, _effects.put)(
                        (0, _setSuggestedActions['default'])(
                          (cov_10uegtnwpw.b[7][0]++, to) &&
                            (cov_10uegtnwpw.b[7][1]++, to.length) &&
                            (cov_10uegtnwpw.b[7][2]++, !to.includes(userID))
                            ? (cov_10uegtnwpw.b[6][0]++, null)
                            : (cov_10uegtnwpw.b[6][1]++, actions)
                        )
                      );

                    case 20:
                      _context.next = 23;
                      break;

                    case 22:
                      cov_10uegtnwpw.b[4][1]++;

                    case 23:
                    case 'end':
                      return _context.stop();
                  }
                }
              }, observeActivity);
            })
          );

        case 5:
        case 'end':
          return _context2.stop();
      }
    }
  }, _marked);
}

function incomingActivitySaga() {
  return _regenerator['default'].wrap(function incomingActivitySaga$(_context3) {
    while (1) {
      switch ((_context3.prev = _context3.next)) {
        case 0:
          cov_10uegtnwpw.f[7]++;
          cov_10uegtnwpw.s[21]++;
          _context3.next = 4;
          return (0, _whileConnected['default'])(observeActivity);

        case 4:
        case 'end':
          return _context3.stop();
      }
    }
  }, _marked2);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9zYWdhcy9pbmNvbWluZ0FjdGl2aXR5U2FnYS5qcyJdLCJuYW1lcyI6WyJvYnNlcnZlQWN0aXZpdHkiLCJpbmNvbWluZ0FjdGl2aXR5U2FnYSIsInBhdGNoQWN0aXZpdHlXaXRoRnJvbVJvbGUiLCJhY3Rpdml0eSIsInVzZXJJRCIsImZyb20iLCJyb2xlIiwiaWQiLCJkaXJlY3RMaW5lIiwiYWN0aXZpdHkkIiwibWVzc2FnZUFjdGl2aXRpZXMiLCJsYXN0TWVzc2FnZUFjdGl2aXR5IiwibGVuZ3RoIiwic3VnZ2VzdGVkQWN0aW9ucyIsImFjdGlvbnMiLCJ0byIsImluY2x1ZGVzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7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QVhELEVBYXBDO0FBQ0E7O0FBZG9DO0FBQUE7QUFlcEMsMkJBQU0sa0JBQUkscUNBQW9CLDJCQUFBQSxFQUFFLGdDQUFJQSxFQUFFLENBQUNILE1BQVAsQ0FBRiwrQkFBbUIsQ0FBQ0csRUFBRSxDQUFDQyxRQUFILENBQVlaLE1BQVosQ0FBcEIsK0JBQTBDLElBQTFDLCtCQUFpRFUsT0FBakQsQ0FBcEIsQ0FBSixDQUFOOztBQWZvQztBQUFBO0FBQUE7O0FBQUE7QUFBQTs7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUEsZUFBVWQsZUFBVjtBQUFBLFdBQWxDLEVBQU47O0FBREY7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7O0FBcUJlLFNBQVVDLG9CQUFWO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFDYixpQkFBTSxnQ0FBZUQsZUFBZixDQUFOOztBQURhO0FBQUE7QUFBQTtBQUFBO0FBQUE7QUFBQTtBQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgcHV0LCBzZWxlY3QgfSBmcm9tICdyZWR1eC1zYWdhL2VmZmVjdHMnO1xuaW1wb3J0IHVwZGF0ZUluIGZyb20gJ3NpbXBsZS11cGRhdGUtaW4nO1xuXG5pbXBvcnQgeyBvZlR5cGUgYXMgYWN0aXZpdGllc09mVHlwZSB9IGZyb20gJy4uL3NlbGVjdG9ycy9hY3Rpdml0aWVzJztcbmltcG9ydCBhY3Rpdml0eUZyb21Cb3QgZnJvbSAnLi4vZGVmaW5pdGlvbnMvYWN0aXZpdHlGcm9tQm90JztcbmltcG9ydCBpbmNvbWluZ0FjdGl2aXR5IGZyb20gJy4uL2FjdGlvbnMvaW5jb21pbmdBY3Rpdml0eSc7XG5pbXBvcnQgb2JzZXJ2ZUVhY2ggZnJvbSAnLi9lZmZlY3RzL29ic2VydmVFYWNoJztcbmltcG9ydCBzZXRTdWdnZXN0ZWRBY3Rpb25zIGZyb20gJy4uL2FjdGlvbnMvc2V0U3VnZ2VzdGVkQWN0aW9ucyc7XG5pbXBvcnQgd2hpbGVDb25uZWN0ZWQgZnJvbSAnLi9lZmZlY3RzL3doaWxlQ29ubmVjdGVkJztcblxuZnVuY3Rpb24gcGF0Y2hBY3Rpdml0eVdpdGhGcm9tUm9sZShhY3Rpdml0eSwgdXNlcklEKSB7XG4gIC8vIFNvbWUgYWN0aXZpdGllcywgc3VjaCBhcyBcIkNvbnZlcnNhdGlvblVwZGF0ZVwiLCBkb2VzIG5vdCBoYXZlIFwiZnJvbVwiIGRlZmluZWQuXG4gIC8vIEFuZCBhbHRob3VnaCBcInJvbGVcIiBpcyBkZWZpbmVkIGluIERpcmVjdCBMaW5lIHNwZWMsIGl0IHdhcyBub3Qgc2VudCBvdmVyIHRoZSB3aXJlLlxuICAvLyBXZSBub3JtYWxpemUgdGhlIGFjdGl2aXR5IGhlcmUgdG8gc2ltcGxpZnkgbnVsbC1jaGVjayBhbmQgbG9naWMgbGF0ZXIuXG5cbiAgLy8gUGF0Y2ggYWN0aXZpdHkuZnJvbS5yb2xlIHRvIG1ha2Ugc3VyZSBpdHMgZWl0aGVyIFwiYm90XCIsIFwidXNlclwiLCBvciBcImNoYW5uZWxcIlxuICBpZiAoIWFjdGl2aXR5LmZyb20pIHtcbiAgICBhY3Rpdml0eSA9IHVwZGF0ZUluKGFjdGl2aXR5LCBbJ2Zyb20nLCAncm9sZSddLCAoKSA9PiAnY2hhbm5lbCcpO1xuICB9IGVsc2UgaWYgKCFhY3Rpdml0eS5mcm9tLnJvbGUpIHtcbiAgICBpZiAoYWN0aXZpdHkuZnJvbS5pZCA9PT0gdXNlcklEKSB7XG4gICAgICBhY3Rpdml0eSA9IHVwZGF0ZUluKGFjdGl2aXR5LCBbJ2Zyb20nLCAncm9sZSddLCAoKSA9PiAndXNlcicpO1xuICAgIH0gZWxzZSBpZiAoYWN0aXZpdHkuZnJvbS5pZCkge1xuICAgICAgYWN0aXZpdHkgPSB1cGRhdGVJbihhY3Rpdml0eSwgWydmcm9tJywgJ3JvbGUnXSwgKCkgPT4gJ2JvdCcpO1xuICAgIH0gZWxzZSB7XG4gICAgICBhY3Rpdml0eSA9IHVwZGF0ZUluKGFjdGl2aXR5LCBbJ2Zyb20nLCAncm9sZSddLCAoKSA9PiAnY2hhbm5lbCcpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBhY3Rpdml0eTtcbn1cblxuZnVuY3Rpb24qIG9ic2VydmVBY3Rpdml0eSh7IGRpcmVjdExpbmUsIHVzZXJJRCB9KSB7XG4gIHlpZWxkIG9ic2VydmVFYWNoKGRpcmVjdExpbmUuYWN0aXZpdHkkLCBmdW5jdGlvbiogb2JzZXJ2ZUFjdGl2aXR5KGFjdGl2aXR5KSB7XG4gICAgYWN0aXZpdHkgPSBwYXRjaEFjdGl2aXR5V2l0aEZyb21Sb2xlKGFjdGl2aXR5LCB1c2VySUQpO1xuXG4gICAgeWllbGQgcHV0KGluY29taW5nQWN0aXZpdHkoYWN0aXZpdHkpKTtcblxuICAgIC8vIFVwZGF0ZSBzdWdnZXN0ZWQgYWN0aW9uc1xuICAgIC8vIFRPRE86IFtQM10gV2UgY291bGQgcHV0IHRoaXMgbG9naWMgaW5zaWRlIHJlZHVjZXIgdG8gbWluaW1pemUgbnVtYmVyIG9mIGFjdGlvbnMgZGlzcGF0Y2hlZC5cbiAgICBjb25zdCBtZXNzYWdlQWN0aXZpdGllcyA9IHlpZWxkIHNlbGVjdChhY3Rpdml0aWVzT2ZUeXBlKCdtZXNzYWdlJykpO1xuICAgIGNvbnN0IGxhc3RNZXNzYWdlQWN0aXZpdHkgPSBtZXNzYWdlQWN0aXZpdGllc1ttZXNzYWdlQWN0aXZpdGllcy5sZW5ndGggLSAxXTtcblxuICAgIGlmIChhY3Rpdml0eUZyb21Cb3QobGFzdE1lc3NhZ2VBY3Rpdml0eSkpIHtcbiAgICAgIGNvbnN0IHsgc3VnZ2VzdGVkQWN0aW9uczogeyBhY3Rpb25zLCB0byB9ID0ge30gfSA9IGxhc3RNZXNzYWdlQWN0aXZpdHk7XG5cbiAgICAgIC8vIElmIHN1Z2dlc3RlZCBhY3Rpb25zIGlzIG5vdCBkZXN0aW5lZCB0byBhbnlvbmUsIG9yIGlzIGRlc3RpbmVkIHRvIHRoZSB1c2VyLCBzaG93IGl0LlxuICAgICAgLy8gSW4gb3RoZXIgd29yZHMsIGlmIHN1Z2dlc3RlZCBhY3Rpb25zIGlzIGRlc3RpbmVkIHRvIHNvbWVvbmUgZWxzZSwgZG9uJ3Qgc2hvdyBpdC5cbiAgICAgIHlpZWxkIHB1dChzZXRTdWdnZXN0ZWRBY3Rpb25zKHRvICYmIHRvLmxlbmd0aCAmJiAhdG8uaW5jbHVkZXModXNlcklEKSA/IG51bGwgOiBhY3Rpb25zKSk7XG4gICAgfVxuICB9KTtcbn1cblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24qIGluY29taW5nQWN0aXZpdHlTYWdhKCkge1xuICB5aWVsZCB3aGlsZUNvbm5lY3RlZChvYnNlcnZlQWN0aXZpdHkpO1xufVxuIl19
